# 基于哈里斯角点检测的图像拼接算法报告





### 1. 哈里斯角点检测

#### 1.1 梯度计算
- **实现方法**：采用3×3索贝尔（Sobel）算子计算图像的水平（x）和垂直（y）方向梯度。  
  - 水平梯度算子：`[[-1,0,1], [-2,0,2], [-1,0,1]]`，对垂直边缘敏感；  
  - 垂直梯度算子：`[[1,2,1], [0,0,0], [-1,-2,-1]]`，对水平边缘敏感；  
  - 为减少噪声影响，输入图像先转换为灰度图，再通过卷积计算梯度。

#### 1.2 哈里斯响应值计算
- **核心公式**：角点响应值 \( R = \det(M) - \alpha \cdot \text{tr}(M)^2 \)，其中：  
  - \( M = \begin{bmatrix} A & B \\ B & C \end{bmatrix} \)，\( A = I_x^2 \otimes w \)，\( B = I_xI_y \otimes w \)，\( C = I_y^2 \otimes w \)（\( \otimes \) 为高斯滤波卷积）；  
  - \( \det(M) = AC - B^2 \)（矩阵行列式），\( \text{tr}(M) = A + C \)（矩阵迹）；  
  - 高斯窗口大小设为5×5，\( \alpha = 0.04 \)（经验值，平衡角点与边缘响应）。

#### 1.3 角点筛选与非极大值抑制
- **阈值筛选**：保留响应值 \( R \) 大于"最大值1%"的候选角点；  
- **非极大值抑制**：使用`ndimage.maximum_filter`在5×5邻域内仅保留局部最大值点，避免相邻角点冗余，最终输出角点坐标列表。


### 2. 梯度直方图特征描述子

为角点生成具有旋转不变性的特征向量，步骤如下：
1. **梯度与方向计算**：对每个角点周围16×16区域，计算梯度幅值（\( \sqrt{I_x^2 + I_y^2} \)）和方向（\( \arctan2(I_y, I_x) \)，转换为0°~360°）；  
2. **主方向确定**：统计8个方向（0°、45°…315°）的梯度幅值直方图，取峰值方向作为主方向，旋转区域至主方向以实现旋转不变性；  
3. **特征向量构建**：将16×16区域划分为4×4个4×4单元格，每个单元格构建8维方向直方图，拼接为4×4×8=128维向量并归一化（L2归一化），增强光照鲁棒性。


### 3. 特征匹配

通过欧氏距离度量特征向量相似度，筛选可靠匹配对：
1. **距离计算**：用`scipy.spatial.distance.cdist`计算两幅图像特征向量的欧氏距离矩阵；  
2. **比值测试**：对每个特征点，保留"最小距离/次小距离 ≤ 0.92"的匹配对（剔除模糊匹配）；  
3. **双向验证**：确保匹配点在两幅图像中双向对应，最终输出匹配的角点坐标对。


### 4. 单应矩阵估计与图像对齐

#### 4.1 单应矩阵计算
- 单应矩阵 \( H \) 描述两幅图像的投影变换关系，通过以下步骤求解：  
  1. 对每对匹配点 \( (x_1,y_1) \leftrightarrow (x_2,y_2) \)，构建方程：  
     \[
     \begin{cases} 
     x_2 = \frac{h_{00}x_1 + h_{01}y_1 + h_{02}}{h_{20}x_1 + h_{21}y_1 + h_{22}} \\
     y_2 = \frac{h_{10}x_1 + h_{11}y_1 + h_{12}}{h_{20}x_1 + h_{21}y_1 + h_{22}} 
     \end{cases}
     \]  
  2. 转换为线性方程组 \( A \cdot \text{vec}(H) = 0 \)，用SVD分解求解（取最小奇异值对应的特征向量）；  
  3. 归一化矩阵使 \( h_{22} = 1 \)。

#### 4.2 RANSAC鲁棒估计
- 为排除错误匹配（外点），采用RANSAC算法：  
  1. 随机抽样4对匹配点计算初始单应矩阵；  
  2. 统计"重投影误差（变换后坐标与实际坐标距离）≤ 10像素"的内点；  
  3. 迭代2000次，保留内点数量最多的矩阵作为最优单应矩阵，并重新用所有内点优化。




